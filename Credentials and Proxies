Credentials and Proxies



By Juliano Monteiro

4 min

3

Add a reaction
SQL Server Credentials and Proxies Export Procedure using dbatools
Overview
SQL Server credentials and proxies are essential security objects that enable SQL Server Agent jobs to execute under specific security contexts. Credentials store authentication information for accessing external resources, while proxies map these credentials to SQL Server Agent subsystems. This procedure demonstrates how to export these objects as T-SQL scripts for recreation on another server, ensuring proper migration order and dependencies.​

Understanding Dependencies
The relationship between credentials and proxies is hierarchical and must be respected during migration:​

Credentials must exist before proxies can be created​

Proxies reference credentials and cannot exist without them​

Agent Jobs may reference proxies in their job steps​

Therefore, the correct execution order is:​​

Create/import credentials first

Create/import proxies second

Create/import Agent jobs last (if applicable)

Prerequisites
Before beginning the export procedure, ensure the following requirements are met:​

dbatools PowerShell module installed

Sysadmin permissions on source SQL Server instance

Remote Windows registry access (for password decryption)

Appropriate file system permissions for script storage

Network access to destination server for validation

Install dbatools if not already available:​



choco install dbatools -Y
Method 1: Export Credentials with Passwords (Production Migration)
Description
This method exports SQL Server credentials including decrypted passwords to executable T-SQL scripts. This is the recommended approach for server migrations where credentials must be recreated exactly as they exist on the source.​

Use Case
Essential for production migrations, disaster recovery scenarios, or when setting up new environments that require exact credential replication.​

Security Considerations
CRITICAL: Exported credential scripts contain clear-text passwords. These files must be stored securely with restricted permissions and encrypted storage.​​

Example - Export All Credentials with Passwords


# Step 1: Export credentials with passwords
$params = @{
    SqlInstance = 'SQL01-PROD'
    Path = 'C:\SecureExport\Credentials'
}
Export-DbaCredential @params
Example - Export Specific Credentials


# Export only specific credentials by identity
$params = @{
    SqlInstance = 'SQL01-PROD'
    Identity = 'AzureBackupAccount', 'LinkedServerAccount', 'ETLServiceAccount'
    Path = 'C:\SecureExport\Credentials'
}
Export-DbaCredential @params
Method 2: Export Credentials Without Passwords (Documentation)
Description
This method exports credential definitions without sensitive password information. This is suitable for documentation, auditing, or security-conscious scenarios where passwords cannot be stored in clear text.​

Use Case
Best for documentation purposes, compliance auditing, or when organizational security policies prohibit storing clear-text passwords.​

Example - Export Without Passwords


# Export credentials without sensitive data
$params = @{
    SqlInstance = 'SQL01-PROD'
    Path = 'C:\Documentation\Credentials'
    ExcludePassword = $true
}
Export-DbaCredential @params
Method 3: Export Proxies
Description
This method exports SQL Server Agent proxy accounts to T-SQL scripts. Proxies depend on credentials, so credentials must be created on the destination server before proxy scripts are executed.​

Use Case
Required when migrating SQL Server Agent jobs that use proxy accounts to execute under different security contexts.​

Important Notes
Proxies cannot be exported directly to scripts like credentials​

Use Copy-DbaAgentProxy for direct server-to-server migration​

Associated credentials must exist on destination before proxy creation​

Example - Direct Proxy Copy Between Servers


# Copy all proxies from source to destination
$params = @{
    Source = 'SQL01-PROD'
    Destination = 'SQL02-DR'
}
Copy-DbaAgentProxy @params
Example - Copy Specific Proxies


# Copy only specific proxy accounts
$params = @{
    Source = 'SQL01-PROD'
    Destination = 'SQL02-DR'
    ProxyAccount = 'ETLProxy', 'BackupProxy', 'MaintenanceProxy'
}
Copy-DbaAgentProxy @params
Example - Force Overwrite Existing Proxies


# Drop and recreate proxies on destination
$params = @{
    Source = 'SQL01-PROD'
    Destination = 'SQL02-DR'
    Force = $true
}
Copy-DbaAgentProxy @params
Method 4: Generate Proxy Creation Scripts Manually
Description
Since there is no native Export-DbaAgentProxy command, this method demonstrates how to generate T-SQL scripts for proxy creation using SMO objects and Export-DbaScript.​

Use Case
Useful when direct server-to-server connection is not available or when scripts must be reviewed before execution.​

Example - Script Out Proxies


# Generate proxy creation scripts
$timestamp = Get-Date -Format 'yyyyMMdd_HHmmss'
$exportPath = "C:\SecureExport\Proxies"
# Create export directory
if (-not (Test-Path $exportPath)) {
    New-Item -Path $exportPath -ItemType Directory | Out-Null
}
# Get all proxies and export scripts
Get-DbaAgentProxy -SqlInstance 'SQL01-PROD' | 
    Export-DbaScript -Path "$exportPath\Proxies_$timestamp.sql"
Execution Order Summary
The correct execution order for credential and proxy migration is critical:​​

Export Order (Source Server)
Export Credentials - Use Export-DbaCredential​

Export Proxies - Use Export-DbaScript with Get-DbaAgentProxy​

Import Order (Destination Server)
Import Credentials - Execute credential script FIRST​

Import Proxies - Execute proxy script SECOND​

Verify Mappings - Confirm proxy-credential relationships​

Best Practices
Secure Password Handling
Credential exports contain clear-text passwords and require special security measures:​​

Store export files in encrypted locations with restricted permissions

Use secure file transfer methods (encrypted channels)

Delete export files immediately after successful migration

Audit access to export directories

Consider using Azure Key Vault or similar secret management solutions

Dependency Validation
Always validate dependencies before execution:​



# Verify credentials exist before creating proxies
$requiredCredentials = @('AzureBackupAccount', 'ETLServiceAccount')
foreach ($cred in $requiredCredentials) {
    if (-not (Get-DbaCredential -SqlInstance 'SQL02-DR' -Name $cred)) {
        throw "Required credential not found: $cred"
    }
}
File Organization
Organize exports with clear naming conventions:​

Use numeric prefixes (01_, 02_) to indicate execution order

Include timestamps for version tracking

Separate credentials and proxies into distinct directories

Include README files with execution instructions

Testing Before Production
Always test the complete migration procedure in a non-production environment first:​



# Test import in development environment
$testInstance = 'SQL-DEV'
# Validate scripts without executing
$credentialScript = Get-Content 'C:\Export\Credentials\01_Credentials.sql' -Raw
Write-Output "Credential script preview:"
$credentialScript | Select-Object -First 20
Troubleshooting
Credential Export Requires Sysadmin Rights
If credential export fails, verify you have sysadmin permissions and remote registry access:​



# Verify permissions
$permissions = Get-DbaPermission -SqlInstance 'SQL01-PROD'
$permissions | Where-Object Member -like "*$env:USERNAME*"
Proxy Creation Fails - Missing Credential
If proxy creation fails, verify the associated credential exists:​



# Verify required credentials exist
Get-DbaCredential -SqlInstance 'SQL02-DR' | Select-Object Name, Identity
Remote Registry Access Issues
If password decryption fails, ensure remote registry access is enabled:​



# Test remote registry connectivity
Test-DbaConnection -SqlInstance 'SQL01-PROD' -EnableException
Add label
