
-- Coletar evidencia de troca de senha

select @@servername as ServerName, t1.UserLogin,t2.createdate,t1.lastpassword_resetTime from
(select 'username' as UserLogin, LOGINPROPERTY('username','PasswordLastSetTime') as lastPassword_ResetTime) t1
inner join sys.syslogins t2 on t1.UserLogin = t2.Loginname

--How to find the date a login password was last changed

SELECT LOGINPROPERTY('YourLoginName', 'PasswordLastSetTime') AS LastPasswordChange;
----------------------------------------------------------------------------------

-----------------------------------------------------------------------------
--list users  inside a windows/AD group
EXEC xp_logininfo 'GSM1900\ADM_SQLAdmin', 'members';
 
 -- para listar os grupos e usuãrios do servidor
 SELECT
          CASE
           WHEN SSPs2.name IS NULL THEN 'Public'
           ELSE SSPs2.name
          END AS 'Role Name',
          SSPs.name AS 'Login Name',
          Case SSPs.is_disabled
           When 0 Then '0 – Enable'
           When 1 Then '1 – Disable'
          End AS 'Login Status',
          SSPs.type_desc AS 'Login Type'
FROM sys.server_principals SSPs
  LEFT JOIN sys.server_role_members SSRM ON SSPs.principal_id  = SSRM.member_principal_id
  LEFT JOIN sys.server_principals SSPs2 ON SSRM.role_principal_id = SSPs2.principal_id
  WHERE SSPs2.name IS NOT NULL
	OR SSPs.type_desc <> 'CERTIFICATE_MAPPED_LOGIN'
	AND SSPs.type_desc <> 'SERVER_ROLE'
	AND SSPs.name NOT LIKE 'NT %'
	AND SSPs2.name IS NULL
ORDER BY SSPs2.name DESC, SSPs.name

-- Para gerar o comando xp_logininfo e listar grupos de windows e usuários nesses grupos:
SELECT
          CASE
           WHEN SSPs2.name IS NULL THEN 'Public'
           ELSE SSPs2.name
          END AS 'Role Name',
          SSPs.name AS 'Login Name',
          Case SSPs.is_disabled
           When 0 Then '0 – Enable'
           When 1 Then '1 – Disable'
          End AS 'Login Status',
          SSPs.type_desc AS 'Login Type',
		  Case SSPs.type_desc
           When 'WINDOWS_GROUP' Then 'Exec xp_logininfo ''' +  SSPs.name+''''+','+''''+'members'+'''; '
          End AS 'Query Windows group'
FROM sys.server_principals SSPs
  LEFT JOIN sys.server_role_members SSRM ON SSPs.principal_id  = SSRM.member_principal_id
  LEFT JOIN sys.server_principals SSPs2 ON SSRM.role_principal_id = SSPs2.principal_id
    WHERE SSPs.type_desc ='WINDOWS_GROUP'
ORDER BY 3
 
